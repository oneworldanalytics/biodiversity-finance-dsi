<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.52">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Identifying Ways Forward – The LSE Roundtable on DSI</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
<meta name="twitter:title" content="Identifying Ways Forward – The LSE Roundtable on DSI">
<meta name="twitter:description" content="">
<meta name="twitter:image" content="pointing_to_cali.jpeg">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">The LSE Roundtable on DSI</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Background</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./presentations.html"> 
<span class="menu-text">Presentations</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="./interim_ways_forward.html" aria-current="page"> 
<span class="menu-text">Ways Forward</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#the-size-of-the-fund" id="toc-the-size-of-the-fund" class="nav-link active" data-scroll-target="#the-size-of-the-fund">The Size of the Fund</a></li>
  <li><a href="#who-should-pay" id="toc-who-should-pay" class="nav-link" data-scroll-target="#who-should-pay">Who Should Pay?</a></li>
  <li><a href="#pay-nature-first-profit-vs-salesturnover" id="toc-pay-nature-first-profit-vs-salesturnover" class="nav-link" data-scroll-target="#pay-nature-first-profit-vs-salesturnover">Pay Nature First: Profit vs Sales/Turnover</a></li>
  <li><a href="#creating-trust-by-doing-conditions-for-trust-in-the-dsi-data-ecosystem" id="toc-creating-trust-by-doing-conditions-for-trust-in-the-dsi-data-ecosystem" class="nav-link" data-scroll-target="#creating-trust-by-doing-conditions-for-trust-in-the-dsi-data-ecosystem">Creating Trust by Doing: Conditions for Trust in the DSI Data Ecosystem</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Identifying Ways Forward</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>The LSE Roundtable brought together experts from a range of fields, industry and database representatives and negotiators from the major UN regions to consider three main questions:</p>
<p>a) What criteria can be used to determine the size of the fund?</p>
<p>b) Who should contribute and based on what measures?</p>
<p>c) How can trust be promoted in the DSI data ecosystem?</p>
<p>The views in this Ways Forward document reflect the analysis of LSE team members based on the discussions at the Roundtable. Full materials and summaries of the presentations delivered at the Roundtable are available <a href="https://oneworldanalytics.com/biodiversity-finance-dsi/presentations.html">here</a>.</p>
<section id="the-size-of-the-fund" class="level3">
<h3 class="anchored" data-anchor-id="the-size-of-the-fund">The Size of the Fund</h3>
<p>DSI is a digital economic asset of global importance. A range of methods are available for valuing data, but to date, no work has been initiated to establish the value of DSI based on the quality and informational content of the asset. The transition to natural capital accounting provides an opportunity to assess the value of DSI data within the United Nations System of National Accounts (the SNA) and wider UN economic reporting framework.<a href="#_ftn1">[1]</a> Parties may wish to initiate further work on approaches to valuing DSI within the context of natural capital accounting and the UN system for economic reporting (see Decision 15/5, para 4).</p>
<p>In the absence of work on DSI valuation, a decision on the size of the fund is essentially political. Parties may wish to create a means for measuring future success by establishing an anchor reference sum as a <em>floor</em> for the fund that can be scaled up based on operational experience and an improved process for DSI valuation. To explore this, a ‘<a href="https://www.dropbox.com/scl/fi/571c4fm7s0a4lm8yil9bo/Kamath_TOY_MODEL_To_be_printed.xlsx?rlkey=4ppi09aipdx0xq4caeokn5ejv&amp;st=yh4yd2im&amp;dl=0">toy model</a>’ for a fund of US$2-20 billion per year was created, divided by country and weighted by annual GDP to assess contributions needed to reach an anchor sum. Parties are invited to consider supporting further work on economic modelling to assess scenarios for the fund including different thresholds for contributions.</p>
</section>
<section id="who-should-pay" class="level3">
<h3 class="anchored" data-anchor-id="who-should-pay">Who Should Pay?</h3>
<p>A <a href="https://www.dropbox.com/scl/fi/12pytjixbvmawio869dwf/Makowska-Revenue-Model-Components-Table-PRINTED.pptx?rlkey=b8hxgviuu29gojol7bfgxzzlq&amp;st=t0haqk1u&amp;dl=0">model</a> of Options A to D identified sources of information available to governments or to the public and considered the undefined concept of ‘DSI reliance’.<sup><a href="#_ftn2">[2]</a></sup> Given the data sources presently available, attempts to define ‘DSI reliant’ products with legal certainty are likely to fail.</p>
<p>The United Nations Statistics Division (UNSD) is the steward of a family of classifications agreed by member states as part of the framework of economic reporting and the System of National Accounts. The International Standard Industrial Classification of All Economic Activities (ISIC) classifies entities by type of economic activity and forms the basis for regional and national classifications in use worldwide by governments for the organisation of economic reporting by industry and sectors. ISIC is directly linked to a number of classification systems for products, services and intellectual property through the Central Product Classification (CPC) and the World Customs Organization’s Harmonized System (HS) for international trade in goods. These classifications are linked to industries and cover thousands of product groups. Patent and statistical authorities also use classification schemes to map trends in activity by sector and <a href="https://www.dropbox.com/scl/fi/lfhc3xcqfdsjwkchst2mb/oldham_patent_data_dsi.pptx?rlkey=8doya9np6eledpi8dnmeg6suy&amp;st=0ylfh91d&amp;dl=0">patent data can&nbsp; be used to identify entities using DSI.</a> The classifications are routinely used in economic reporting by governments. Taken together, product classifications and patent data can assist in identifying sectors that <em>directly</em> or <em>indirectly</em> benefit from DSI.</p>
<p>Parties are invited to use the family of economic classification systems operated by the United Nations Statistics Division including, <em>inter alia</em>; the International Standard Industrial Classification of All Economic Activities (ISIC), the Central Product Classification (CPC) and Harmonised System (HS) and their regional and national equivalents to support implementation of the multilateral mechanism on DSI. Inputs from the UNSD and regional and national statistical authorities, including patent authorities, on the use of the classification family for the implementation of the international mechanism on DSI would be helpful.</p>
</section>
<section id="pay-nature-first-profit-vs-salesturnover" class="level3">
<h3 class="anchored" data-anchor-id="pay-nature-first-profit-vs-salesturnover">Pay Nature First: Profit vs Sales/Turnover</h3>
<p>The Roundtable concluded that sales/turnover is the appropriate measure based on the principles of ‘paying nature first’ and treating contributions to the DSI fund as a pre-profit cost of doing business.</p>
<p>In accountancy the terms sales, revenue and turnover are different words for the same thing.<sup><a href="#_ftn3">[3]</a></sup> The real distinction is between profit and sales/turnover. Using profit can protect new and small businesses who may have high sales but low profits, but profits are more manipulable, and fluctuations in profit could cause yearly variations in the funds raised. Further, full data is likely to be available only to tax authorities. In contrast, data on sales/turnover is less open to manipulation. It is widely available on the sector level and for exports as part of the System of National Accounts and UN reporting framework.</p>
<p>Taking into account the different characteristics of economies and economic activity a <em>basket of measures</em> led by sales/turnover but including profit and the value of total assets as the formula for the calculation of contributions is the most likely to be equitable. Such a basket could be led by a percentage of sales/turnover and include different bands across which the percentage varies. To give flexibility in defining fair thresholds for contributions from entities of different sizes (i.e.&nbsp;different bands), a ‘2 out of 3’ approach is recommended for meeting the thresholds out of sales/turnover, profit/net income and the value of total assets. Using averages over 3 years for the above metrics can remove the effect of spikes and troughs in activity.</p>
<p>Experience in the EU strongly suggests that ‘opt out’ approaches to contributions combined with disclosures (e.g.&nbsp;CSR/ESG) will work best. In ‘opt out’ systems all entities meeting certain criteria are assumed to be in the bucket. Entities may be able to opt out where a justification is made against a set of criteria, transferring the burden of proof to entities (e.g.&nbsp;<a href="https://environment.ec.europa.eu/topics/chemicals/reach-regulation_en">EU REACH legislation</a>). Experience in the EU, India &amp; China with Corporate Social Responsibility (CSR)/Environment, Social and Governance (ESG) reporting reveals positive impacts on behaviour and may make companies more attractive to investors. Combining opt out with disclosure approaches could avoid a need for Parties to legally define DSI.</p>
<p>Prospective contributions should be based on guiding principles such as the FRETAP principles: that they be Fair (apply to all), Reasonable (e.g.&nbsp;not 99% of sales), Equitable (across economies), Transparent (public) and Predictable.<sup><a href="#_ftn4">[4]</a></sup></p>
</section>
<section id="creating-trust-by-doing-conditions-for-trust-in-the-dsi-data-ecosystem" class="level3">
<h3 class="anchored" data-anchor-id="creating-trust-by-doing-conditions-for-trust-in-the-dsi-data-ecosystem">Creating Trust by Doing: Conditions for Trust in the DSI Data Ecosystem</h3>
<p>Decision 15/9 includes references to the 2021 UNESCO Recommendation on Open Science, the OECD Recommendation on Enhancing Access to and Sharing of Data, the FAIR and CARE principles and encourages the deposit of DSI in public databases. In order to operationalise these goals and ensure a return for biodiversity from the use of global public DSI data, a new framework for trust is needed in the DSI ecosystem. That trust can only be achieved through practical action.</p>
<p>The ability to maintain relationships between samples and digital objects such as sequences is central to modern science. Recognition that modern science involving DSI depends on identifiers opens up opportunities to support good scientific practice <em>and</em> improve transparency to Parties using standard scientific templates such as those used for BioSamples (sample metadata). At the same time Parties, through guidance from funding agencies, could promote greater awareness of the importance of accurate metadata within the scientific community. Building on increasing requirements for location information from the INSDC, these small but important steps could radically improve the transparency of DSI to Parties and Indigenous Peoples and local communities, and therefore build trust.</p>
<p>Using identifiers for accessions <a href="https://www.dropbox.com/scl/fi/779sga69h9k8oo5fao892/oldham_data_trust_alphafold.pptx?rlkey=6eb8rfajg2hxvr3c58xeh4ejm&amp;st=053tmw19&amp;dl=0">allows nucleotide sequences to be mapped to protein sequences</a> and, in turn, allows proteins to be mapped to tools such as EMBL-EBI and Google’s Alphafold2. EMBL-EBI and Google Alphafold2 data is made available under a permissive Creative Commons Attribution Licence (CC-BY). However, recent efforts by Google to obtain a return on its investment in AI in AlphaFold3 raises the question of how public databases as custodians of global public DSI data should act with respect to such commercial opportunities. To generate conditions of trust and secure a return for biodiversity, Parties may wish to consider the use of a Sovereign Commons Licence (SCL). <sup><a href="#_ftn5">[5]</a></sup></p>
<p>United Nations member states enjoy <a href="https://www.ohchr.org/en/instruments-mechanisms/instruments/general-assembly-resolution-1803-xvii-14-december-1962-permanent">permanent sovereignty</a> over their natural resources. The proposed Sovereign Commons Licence pools authorisation for the sharing and use of digital sequence information linked with obligations for benefit sharing through the multilateral benefit sharing mechanism, while retaining sovereignty. Parties would require that sequences with the SCL would only be submitted to databases and repositories participating in the multilateral mechanism. Parties would set out the impact, terms of use and conditions of benefit sharing in the SCL. Parties to the Nagoya Protocol, at their discretion, could use the SCL as the default licence in MAT. It would be open to other UN member states to use the SCL in the sharing of sequence data. Parties would take steps to recognise and respect the rights of Indigenous Peoples set out in UNDRIP in the SCL. Users of DSI under the SCL would secure legal certainty. Such a licence could be iteratively updated based on operational experience.</p>
<p><em>The LSE Roundtable on Global Biodiversity Finance and Digital Sequence Information was organised by the Ocean Biodiversity Collective (funded by LSE Knowledge Exchange and Impact) and One World Analytics; and facilitated by the Meridian Institute and the Grantham Research Institute. We are grateful for substantial funding from NORAD. Summaries and recordings of the expert presentations that were not included under the Chatham House rule are available <a href="https://oneworldanalytics.com/biodiversity-finance-dsi/presentations.html">here</a>; an expanded version of this document will follow. For more information contact Dr Siva Thambisetty (LSE Law School) s.thambisetty@lse.ac.uk or Dr Paul Oldham (OWA) poldham@oneworldanalytics.com. For queries about the website contact Jasmine Kindness: jasmine@oneworldanalytics.com</em></p>
<p><a href="#_ftnref1">[1]</a> Lea Reitmeier <a href="https://www.dropbox.com/scl/fi/j7ggd61oasvucmyjmljw3/National-Accounting-Standards_v4.docx?rlkey=5rvzghy144dtl0yurmof7xwz0&amp;st=41yx09n0&amp;dl=0">National Accounting Standards</a></p>
<p><a href="#_ftnref2">[2]</a> Agata Makowska-Curran <a href="https://www.dropbox.com/scl/fi/1hrvbshoatptfi0widc5x/Makowska-Curran_DSI-Models.pptx?rlkey=8lrn2iu035d43sssr4sh0bqwi&amp;st=q681dqfl&amp;dl=0">Mapping DSI Options A-D</a></p>
<p><a href="#_ftnref3">[3]</a> Saipriya Kamath <a href="https://www.dropbox.com/scl/fi/m0radq2vc9apc2k1lscz7/Kamath_unlocking_private_capital.pptx?rlkey=i5kt0aji1k4etsl9v9es4vmqo&amp;st=ew4m55xr&amp;dl=0">Unlocking Private Capital: Navigating Regulation, Metrics and Investor Motivation</a></p>
<p><a href="#_ftnref4">[4]</a> Paul Oldham and Siva Thambisetty 2024 The Pandemic Access and Benefit Sharing System: Four Elements of a Trusted System. <a href="https://dx.doi.org/10.2139/ssrn.4877517" class="uri">https://dx.doi.org/10.2139/ssrn.4877517</a></p>
<p><a href="#_ftnref5">[5]</a> Paul Oldham and Siva Thambisetty 2024 <a href="https://www.dropbox.com/scl/fi/bv46r6269o59lvj9nx2el/The-Sovereign-Commons-Licence.pdf?rlkey=rvmhwslxxn39iwwm8ijvzhu3l&amp;st=2m7fwh4i&amp;dl=0">The Sovereign Commons Licence</a>.</p>


</section>

<script async="" defer="" src="https://scripts.simpleanalyticscdn.com/latest.js"></script></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>